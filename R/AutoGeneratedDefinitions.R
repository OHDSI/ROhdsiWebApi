# Copyright 2020 Observational Health Data Sciences and Informatics
#
# This file is part of FeatureExtraction
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# This file has been autogenerated. Do not change by hand.




#' Retrieve the meta data for ConceptSet definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for ConceptSet. This function is useful to retrieve the current ConceptSet
#' specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for ConceptSet. Note: modifiedDate and createdDate are returned
#' as text/character.
#'
#' @examples
#' \dontrun{
#' getConceptSetDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getConceptSetDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("conceptSet"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if ConceptSet id is valid.
#'
#' @details
#' Checks if a set of id for a ConceptSet is valid, i.e. checks if all the ids exists in the WebApi
#' i.e. valid.
#'
#' @template BaseUrl
#' @param conceptSetIds   A list of integer id(s) of the ConceptSet to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidConceptSetId(conceptSetIds = c(13242, 3423, 34), baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidConceptSetId <- function(conceptSetIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(conceptSetIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "conceptSet")
  return(conceptSetIds %in% validIds$id)
}




#' Get ConceptSet id definition.
#'
#' @details
#' Obtain the ConceptSet definition from WebAPI for a given ConceptSet id
#'
#' @template BaseUrl
#' @param conceptSetId   An integer id representing the id that uniquely identifies a ConceptSet
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the ConceptSet definition
#'
#' @examples
#' \dontrun{
#' getConceptSetDefinition(conceptSetId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getConceptSetDefinition <- function(conceptSetId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "conceptSet")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(conceptSetId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidConceptSetId(conceptSetIds = conceptSetId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", conceptSetId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  conceptSetId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("ConceptSetId : conceptSetId is not present in the WebApi.")
  }
}




#' Delete ConceptSet id definition.
#'
#' @details
#' Delete the ConceptSet definition from WebAPI for a given ConceptSet id
#'
#' @template BaseUrl
#' @param conceptSetId   An integer id representing the id that uniquely identifies a ConceptSet
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the ConceptSet definition
#'
#' @examples
#' \dontrun{
#' deleteConceptSetDefinition(conceptSetId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deleteConceptSetDefinition <- function(conceptSetId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "conceptSet")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(conceptSetId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidConceptSetId(conceptSetIds = conceptSetId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", conceptSetId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("ConceptSetId : conceptSetId is not present in the WebApi.")
  }
}




#' Check if ConceptSet definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a ConceptSet definition name.
#'
#' @template BaseUrl
#' @param conceptSetName   A string name for the ConceptSet to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsConceptSetName(conceptSetName = "this text string needs to be checked",
#'                      baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsConceptSetName <- function(conceptSetName, baseUrl) {
  definitionsMetaData <- getConceptSetDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$conceptSetName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}


#' Retrieve the meta data for Cohort definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for Cohort. This function is useful to retrieve the current Cohort
#' specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for Cohort. Note: modifiedDate and createdDate are returned as
#' text/character.
#'
#' @examples
#' \dontrun{
#' getCohortDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getCohortDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("cohort"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if Cohort id is valid.
#'
#' @details
#' Checks if a set of id for a Cohort is valid, i.e. checks if all the ids exists in the WebApi i.e.
#' valid.
#'
#' @template BaseUrl
#' @param cohortIds   A list of integer id(s) of the Cohort to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidCohortId(cohortIds = c(13242, 3423, 34), baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidCohortId <- function(cohortIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(cohortIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "cohort")
  return(cohortIds %in% validIds$id)
}




#' Get Cohort id definition.
#'
#' @details
#' Obtain the Cohort definition from WebAPI for a given Cohort id
#'
#' @template BaseUrl
#' @param cohortId   An integer id representing the id that uniquely identifies a Cohort definition in
#'                   a WebApi instance.
#' @return
#' An R object representing the Cohort definition
#'
#' @examples
#' \dontrun{
#' getCohortDefinition(cohortId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getCohortDefinition <- function(cohortId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "cohort")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(cohortId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidCohortId(cohortIds = cohortId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", cohortId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  cohortId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("CohortId : cohortId is not present in the WebApi.")
  }
}




#' Delete Cohort id definition.
#'
#' @details
#' Delete the Cohort definition from WebAPI for a given Cohort id
#'
#' @template BaseUrl
#' @param cohortId   An integer id representing the id that uniquely identifies a Cohort definition in
#'                   a WebApi instance.
#' @return
#' An R object representing the Cohort definition
#'
#' @examples
#' \dontrun{
#' deleteCohortDefinition(cohortId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deleteCohortDefinition <- function(cohortId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "cohort")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(cohortId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidCohortId(cohortIds = cohortId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", cohortId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("CohortId : cohortId is not present in the WebApi.")
  }
}




#' Check if Cohort definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a Cohort definition name.
#'
#' @template BaseUrl
#' @param cohortName   A string name for the Cohort to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsCohortName(cohortName = "this text string needs to be checked",
#'                  baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsCohortName <- function(cohortName, baseUrl) {
  definitionsMetaData <- getCohortDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$cohortName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}

#' Get generation information for Cohort id.
#'
#' @details
#' Get generation (execution) information about Cohort for a given combination of sourceKey and
#' cohortId.
#'
#' @template BaseUrl
#' @template SourceKey
#' @param cohortId   An integer id representing the id that uniquely identifies a Cohort definition in
#'                   a WebApi instance.
#' @return
#' An R object representing the Cohort definition
#'
#' @examples
#' \dontrun{
#' getCohortGenerationInformation(cohortId = 13242,
#'                                baseUrl = "http://server.org:80/WebAPI",
#'                                sourceKey = "HCUP")
#' }
#' @export
getCohortGenerationInformation <- function(cohortId, sourceKey, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "cohort")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(cohortId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  url <- paste0(baseUrl,
                "/",
                argument$categoryUrl,
                "/",
                cohortId,
                "/",
                argument$categoryUrlGenerationInformation)
  response <- httr::GET(url)
  if (!response$status_code %in% c(100, 200)) {
    stop("No Cohort generation information found.")
  }
  response <- httr::content(response)

  responseAll <- list()
  for (i in (1:length(response))) {
    responseAll[[i]] <- response[[i]] %>% unlist(recursive = TRUE,
                                                 use.names = TRUE) %>% as.matrix() %>%
      t() %>% tidyr::as_tibble() %>% dplyr::mutate_if(.integerCharacters,
                                                      as.integer) %>% dplyr::mutate_if(.numericCharacters,
                                                                                       as.numeric) %>% dplyr::mutate_if(.logicalCharacters, as.logical) %>% dplyr::mutate(cohortId = !!cohortId) %>%
      dplyr::mutate(listId = !!i)
  }
  response <- dplyr::bind_rows(responseAll)

  cdmDataSources <- getCdmSources(baseUrl) %>% dplyr::select(.data$sourceId, .data$sourceKey)

  if ("executionInfo.id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "executionInfo.",
                                            replacement = "")
  }
  if ("id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "id.",
                                            replacement = "")
  }
  if ("sourceId" %in% colnames(response)) {
    response <- response %>% dplyr::left_join(y = cdmDataSources, by = "sourceId")
  }
  return(response)
}





#' Invoke generation of Cohort id.
#'
#' @details
#' Invoke the generation of Cohort id in the WebApi.
#'
#' @template BaseUrl
#' @param cohortId   An integer id representing the id that uniquely identifies a Cohort definition in
#'                   a WebApi instance.
#' @template SourceKey
#' @return
#' An R object representing the Cohort definition
#'
#' @examples
#' \dontrun{
#' invokeCohortDefinition(CohortId = 13242,
#'                        baseUrl = "http://server.org:80/WebAPI",
#'                        sourceKey = "HCUP")
#' }
#' @export
invokeCohortDefinition <- function(cohortId, baseUrl, sourceKey) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "cohort")

  # get valid source keys from webapi
  validSourceKeys <- getCdmSources(baseUrl = baseUrl) %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull()
  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(cohortId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::assertNames(sourceKey,
                         subset.of = validSourceKeys %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull(), add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidCohortId(cohortIds = cohortId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", cohortId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("CohortId : cohortId is not present in the WebApi.")
  }
}

#' Get SQL query for Cohort definition.
#'
#' @details
#' Given a valid Cohort specification R-object (not JSON) this function will return the parameterized
#' SQL in OHDSI SQL dialect. This SQL then may be used along with OHDSI R-package 'SQLRender' to
#' render/translate to target SQL dialect and parameters rendered.
#'
#' @template BaseUrl
#' @param cohortDefinitionExpression   An R list object (not JSON) representing the Cohort definition.
#'                                     It is the output R expression object of list object from
#'                                     \code{CohortDefinition}
#' @return
#' An R object containing the SQL for Cohort definition.
#'
#' @examples
#' \dontrun{
#' getCohortDefinitionSqlFromExpression(CohortDefinitionExpression = 13242,
#'                                      baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getCohortDefinitionSqlFromExpression <- function(cohortDefinitionExpression, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "cohort")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertList(x = cohortDefinitionExpression, min.len = 1, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  url <- paste0(baseUrl, "/", argument$categoryUrl, "/sql/")
  httpheader <- c(Accept = "application/json; charset=UTF-8", `Content-Type` = "application/json")
  validJsonExpression <- RJSONIO::toJSON(cohortDefinitionExpression)
  body <- RJSONIO::toJSON(list(expression = RJSONIO::fromJSON(validJsonExpression)), digits = 23)
  req <- httr::POST(url, body = body, config = httr::add_headers(httpheader))
  sql <- (httr::content(req))$templateSql
  return(sql)
}


#' Retrieve the meta data for IncidenceRate definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for IncidenceRate. This function is useful to retrieve the current
#' IncidenceRate specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for IncidenceRate. Note: modifiedDate and createdDate are
#' returned as text/character.
#'
#' @examples
#' \dontrun{
#' getIncidenceRateDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getIncidenceRateDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("incidenceRate"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if IncidenceRate id is valid.
#'
#' @details
#' Checks if a set of id for a IncidenceRate is valid, i.e. checks if all the ids exists in the WebApi
#' i.e. valid.
#'
#' @template BaseUrl
#' @param incidenceRateIds   A list of integer id(s) of the IncidenceRate to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidIncidenceRateId(incidenceRateIds = c(13242, 3423, 34),
#'                        baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidIncidenceRateId <- function(incidenceRateIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(incidenceRateIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "incidenceRate")
  return(incidenceRateIds %in% validIds$id)
}




#' Get IncidenceRate id definition.
#'
#' @details
#' Obtain the IncidenceRate definition from WebAPI for a given IncidenceRate id
#'
#' @template BaseUrl
#' @param incidenceRateId   An integer id representing the id that uniquely identifies a IncidenceRate
#'                          definition in a WebApi instance.
#' @return
#' An R object representing the IncidenceRate definition
#'
#' @examples
#' \dontrun{
#' getIncidenceRateDefinition(incidenceRateId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getIncidenceRateDefinition <- function(incidenceRateId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "incidenceRate")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(incidenceRateId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidIncidenceRateId(incidenceRateIds = incidenceRateId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", incidenceRateId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  incidenceRateId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("IncidenceRateId : incidenceRateId is not present in the WebApi.")
  }
}




#' Delete IncidenceRate id definition.
#'
#' @details
#' Delete the IncidenceRate definition from WebAPI for a given IncidenceRate id
#'
#' @template BaseUrl
#' @param incidenceRateId   An integer id representing the id that uniquely identifies a IncidenceRate
#'                          definition in a WebApi instance.
#' @return
#' An R object representing the IncidenceRate definition
#'
#' @examples
#' \dontrun{
#' deleteIncidenceRateDefinition(incidenceRateId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deleteIncidenceRateDefinition <- function(incidenceRateId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "incidenceRate")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(incidenceRateId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidIncidenceRateId(incidenceRateIds = incidenceRateId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", incidenceRateId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("IncidenceRateId : incidenceRateId is not present in the WebApi.")
  }
}




#' Check if IncidenceRate definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a IncidenceRate definition name.
#'
#' @template BaseUrl
#' @param incidenceRateName   A string name for the IncidenceRate to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsIncidenceRateName(incidenceRateName = "this text string needs to be checked",
#'                         baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsIncidenceRateName <- function(incidenceRateName, baseUrl) {
  definitionsMetaData <- getIncidenceRateDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$incidenceRateName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}

#' Get generation information for IncidenceRate id.
#'
#' @details
#' Get generation (execution) information about IncidenceRate for a given combination of sourceKey and
#' incidenceRateId.
#'
#' @template BaseUrl
#' @template SourceKey
#' @param incidenceRateId   An integer id representing the id that uniquely identifies a IncidenceRate
#'                          definition in a WebApi instance.
#' @return
#' An R object representing the IncidenceRate definition
#'
#' @examples
#' \dontrun{
#' getIncidenceRateGenerationInformation(incidenceRateId = 13242,
#'                                       baseUrl = "http://server.org:80/WebAPI",
#'                                       sourceKey = "HCUP")
#' }
#' @export
getIncidenceRateGenerationInformation <- function(incidenceRateId, sourceKey, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "incidenceRate")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(incidenceRateId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  url <- paste0(baseUrl,
                "/",
                argument$categoryUrl,
                "/",
                incidenceRateId,
                "/",
                argument$categoryUrlGenerationInformation)
  response <- httr::GET(url)
  if (!response$status_code %in% c(100, 200)) {
    stop("No IncidenceRate generation information found.")
  }
  response <- httr::content(response)

  responseAll <- list()
  for (i in (1:length(response))) {
    responseAll[[i]] <- response[[i]] %>% unlist(recursive = TRUE,
                                                 use.names = TRUE) %>% as.matrix() %>%
      t() %>% tidyr::as_tibble() %>% dplyr::mutate_if(.integerCharacters,
                                                      as.integer) %>% dplyr::mutate_if(.numericCharacters,
                                                                                       as.numeric) %>% dplyr::mutate_if(.logicalCharacters, as.logical) %>% dplyr::mutate(incidenceRateId = !!incidenceRateId) %>%
      dplyr::mutate(listId = !!i)
  }
  response <- dplyr::bind_rows(responseAll)

  cdmDataSources <- getCdmSources(baseUrl) %>% dplyr::select(.data$sourceId, .data$sourceKey)

  if ("executionInfo.id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "executionInfo.",
                                            replacement = "")
  }
  if ("id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "id.",
                                            replacement = "")
  }
  if ("sourceId" %in% colnames(response)) {
    response <- response %>% dplyr::left_join(y = cdmDataSources, by = "sourceId")
  }
  return(response)
}





#' Invoke generation of IncidenceRate id.
#'
#' @details
#' Invoke the generation of IncidenceRate id in the WebApi.
#'
#' @template BaseUrl
#' @param incidenceRateId   An integer id representing the id that uniquely identifies a IncidenceRate
#'                          definition in a WebApi instance.
#' @template SourceKey
#' @return
#' An R object representing the IncidenceRate definition
#'
#' @examples
#' \dontrun{
#' invokeIncidenceRateDefinition(IncidenceRateId = 13242,
#'                               baseUrl = "http://server.org:80/WebAPI",
#'                               sourceKey = "HCUP")
#' }
#' @export
invokeIncidenceRateDefinition <- function(incidenceRateId, baseUrl, sourceKey) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "incidenceRate")

  # get valid source keys from webapi
  validSourceKeys <- getCdmSources(baseUrl = baseUrl) %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull()
  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(incidenceRateId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::assertNames(sourceKey,
                         subset.of = validSourceKeys %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull(), add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidIncidenceRateId(incidenceRateIds = incidenceRateId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", incidenceRateId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("IncidenceRateId : incidenceRateId is not present in the WebApi.")
  }
}


#' Retrieve the meta data for Estimation definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for Estimation. This function is useful to retrieve the current Estimation
#' specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for Estimation. Note: modifiedDate and createdDate are returned
#' as text/character.
#'
#' @examples
#' \dontrun{
#' getEstimationDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getEstimationDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("estimation"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if Estimation id is valid.
#'
#' @details
#' Checks if a set of id for a Estimation is valid, i.e. checks if all the ids exists in the WebApi
#' i.e. valid.
#'
#' @template BaseUrl
#' @param estimationIds   A list of integer id(s) of the Estimation to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidEstimationId(estimationIds = c(13242, 3423, 34), baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidEstimationId <- function(estimationIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(estimationIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "estimation")
  return(estimationIds %in% validIds$id)
}




#' Get Estimation id definition.
#'
#' @details
#' Obtain the Estimation definition from WebAPI for a given Estimation id
#'
#' @template BaseUrl
#' @param estimationId   An integer id representing the id that uniquely identifies a Estimation
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the Estimation definition
#'
#' @examples
#' \dontrun{
#' getEstimationDefinition(estimationId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getEstimationDefinition <- function(estimationId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "estimation")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(estimationId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidEstimationId(estimationIds = estimationId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", estimationId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  estimationId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("EstimationId : estimationId is not present in the WebApi.")
  }
}




#' Delete Estimation id definition.
#'
#' @details
#' Delete the Estimation definition from WebAPI for a given Estimation id
#'
#' @template BaseUrl
#' @param estimationId   An integer id representing the id that uniquely identifies a Estimation
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the Estimation definition
#'
#' @examples
#' \dontrun{
#' deleteEstimationDefinition(estimationId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deleteEstimationDefinition <- function(estimationId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "estimation")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(estimationId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidEstimationId(estimationIds = estimationId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", estimationId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("EstimationId : estimationId is not present in the WebApi.")
  }
}




#' Check if Estimation definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a Estimation definition name.
#'
#' @template BaseUrl
#' @param estimationName   A string name for the Estimation to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsEstimationName(estimationName = "this text string needs to be checked",
#'                      baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsEstimationName <- function(estimationName, baseUrl) {
  definitionsMetaData <- getEstimationDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$estimationName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}


#' Retrieve the meta data for Prediction definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for Prediction. This function is useful to retrieve the current Prediction
#' specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for Prediction. Note: modifiedDate and createdDate are returned
#' as text/character.
#'
#' @examples
#' \dontrun{
#' getPredictionDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getPredictionDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("prediction"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if Prediction id is valid.
#'
#' @details
#' Checks if a set of id for a Prediction is valid, i.e. checks if all the ids exists in the WebApi
#' i.e. valid.
#'
#' @template BaseUrl
#' @param predictionIds   A list of integer id(s) of the Prediction to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidPredictionId(predictionIds = c(13242, 3423, 34), baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidPredictionId <- function(predictionIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(predictionIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "prediction")
  return(predictionIds %in% validIds$id)
}




#' Get Prediction id definition.
#'
#' @details
#' Obtain the Prediction definition from WebAPI for a given Prediction id
#'
#' @template BaseUrl
#' @param predictionId   An integer id representing the id that uniquely identifies a Prediction
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the Prediction definition
#'
#' @examples
#' \dontrun{
#' getPredictionDefinition(predictionId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getPredictionDefinition <- function(predictionId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "prediction")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(predictionId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidPredictionId(predictionIds = predictionId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", predictionId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  predictionId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("PredictionId : predictionId is not present in the WebApi.")
  }
}




#' Delete Prediction id definition.
#'
#' @details
#' Delete the Prediction definition from WebAPI for a given Prediction id
#'
#' @template BaseUrl
#' @param predictionId   An integer id representing the id that uniquely identifies a Prediction
#'                       definition in a WebApi instance.
#' @return
#' An R object representing the Prediction definition
#'
#' @examples
#' \dontrun{
#' deletePredictionDefinition(predictionId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deletePredictionDefinition <- function(predictionId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "prediction")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(predictionId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidPredictionId(predictionIds = predictionId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", predictionId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("PredictionId : predictionId is not present in the WebApi.")
  }
}




#' Check if Prediction definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a Prediction definition name.
#'
#' @template BaseUrl
#' @param predictionName   A string name for the Prediction to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsPredictionName(predictionName = "this text string needs to be checked",
#'                      baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsPredictionName <- function(predictionName, baseUrl) {
  definitionsMetaData <- getPredictionDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$predictionName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}


#' Retrieve the meta data for Characterization definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for Characterization. This function is useful to retrieve the current
#' Characterization specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for Characterization. Note: modifiedDate and createdDate are
#' returned as text/character.
#'
#' @examples
#' \dontrun{
#' getCharacterizationDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getCharacterizationDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("characterization"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if Characterization id is valid.
#'
#' @details
#' Checks if a set of id for a Characterization is valid, i.e. checks if all the ids exists in the
#' WebApi i.e. valid.
#'
#' @template BaseUrl
#' @param characterizationIds   A list of integer id(s) of the Characterization to be tested for
#'                              validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidCharacterizationId(characterizationIds = c(13242, 3423, 34),
#'                           baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidCharacterizationId <- function(characterizationIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(characterizationIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "characterization")
  return(characterizationIds %in% validIds$id)
}




#' Get Characterization id definition.
#'
#' @details
#' Obtain the Characterization definition from WebAPI for a given Characterization id
#'
#' @template BaseUrl
#' @param characterizationId   An integer id representing the id that uniquely identifies a
#'                             Characterization definition in a WebApi instance.
#' @return
#' An R object representing the Characterization definition
#'
#' @examples
#' \dontrun{
#' getCharacterizationDefinition(characterizationId = 13242,
#'                               baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getCharacterizationDefinition <- function(characterizationId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "characterization")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(characterizationId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidCharacterizationId(characterizationIds = characterizationId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", characterizationId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  characterizationId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("CharacterizationId : characterizationId is not present in the WebApi.")
  }
}




#' Delete Characterization id definition.
#'
#' @details
#' Delete the Characterization definition from WebAPI for a given Characterization id
#'
#' @template BaseUrl
#' @param characterizationId   An integer id representing the id that uniquely identifies a
#'                             Characterization definition in a WebApi instance.
#' @return
#' An R object representing the Characterization definition
#'
#' @examples
#' \dontrun{
#' deleteCharacterizationDefinition(characterizationId = 13242,
#'                                  baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deleteCharacterizationDefinition <- function(characterizationId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "characterization")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(characterizationId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidCharacterizationId(characterizationIds = characterizationId,
                                       baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", characterizationId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("CharacterizationId : characterizationId is not present in the WebApi.")
  }
}




#' Check if Characterization definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a Characterization definition name.
#'
#' @template BaseUrl
#' @param characterizationName   A string name for the Characterization to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsCharacterizationName(characterizationName = "this text string needs to be checked",
#'                            baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsCharacterizationName <- function(characterizationName, baseUrl) {
  definitionsMetaData <- getCharacterizationDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$characterizationName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}

#' Get generation information for Characterization id.
#'
#' @details
#' Get generation (execution) information about Characterization for a given combination of sourceKey
#' and characterizationId.
#'
#' @template BaseUrl
#' @template SourceKey
#' @param characterizationId   An integer id representing the id that uniquely identifies a
#'                             Characterization definition in a WebApi instance.
#' @return
#' An R object representing the Characterization definition
#'
#' @examples
#' \dontrun{
#' getCharacterizationGenerationInformation(characterizationId = 13242,
#'                                          baseUrl = "http://server.org:80/WebAPI",
#'                                          sourceKey = "HCUP")
#' }
#' @export
getCharacterizationGenerationInformation <- function(characterizationId, sourceKey, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "characterization")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(characterizationId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  url <- paste0(baseUrl,
                "/",
                argument$categoryUrl,
                "/",
                characterizationId,
                "/",
                argument$categoryUrlGenerationInformation)
  response <- httr::GET(url)
  if (!response$status_code %in% c(100, 200)) {
    stop("No Characterization generation information found.")
  }
  response <- httr::content(response)

  responseAll <- list()
  for (i in (1:length(response))) {
    responseAll[[i]] <- response[[i]] %>% unlist(recursive = TRUE,
                                                 use.names = TRUE) %>% as.matrix() %>%
      t() %>% tidyr::as_tibble() %>% dplyr::mutate_if(.integerCharacters,
                                                      as.integer) %>% dplyr::mutate_if(.numericCharacters,
                                                                                       as.numeric) %>% dplyr::mutate_if(.logicalCharacters, as.logical) %>% dplyr::mutate(characterizationId = !!characterizationId) %>%
      dplyr::mutate(listId = !!i)
  }
  response <- dplyr::bind_rows(responseAll)

  cdmDataSources <- getCdmSources(baseUrl) %>% dplyr::select(.data$sourceId, .data$sourceKey)

  if ("executionInfo.id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "executionInfo.",
                                            replacement = "")
  }
  if ("id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "id.",
                                            replacement = "")
  }
  if ("sourceId" %in% colnames(response)) {
    response <- response %>% dplyr::left_join(y = cdmDataSources, by = "sourceId")
  }
  return(response)
}





#' Invoke generation of Characterization id.
#'
#' @details
#' Invoke the generation of Characterization id in the WebApi.
#'
#' @template BaseUrl
#' @param characterizationId   An integer id representing the id that uniquely identifies a
#'                             Characterization definition in a WebApi instance.
#' @template SourceKey
#' @return
#' An R object representing the Characterization definition
#'
#' @examples
#' \dontrun{
#' invokeCharacterizationDefinition(CharacterizationId = 13242,
#'                                  baseUrl = "http://server.org:80/WebAPI",
#'                                  sourceKey = "HCUP")
#' }
#' @export
invokeCharacterizationDefinition <- function(characterizationId, baseUrl, sourceKey) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "characterization")

  # get valid source keys from webapi
  validSourceKeys <- getCdmSources(baseUrl = baseUrl) %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull()
  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(characterizationId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::assertNames(sourceKey,
                         subset.of = validSourceKeys %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull(), add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidCharacterizationId(characterizationIds = characterizationId,
                                       baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", characterizationId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("CharacterizationId : characterizationId is not present in the WebApi.")
  }
}


#' Retrieve the meta data for Pathway definitions.
#'
#' @details
#' Obtains the meta data of WebApi specifications such as id, name, created/modified details, hash
#' object, etc. from WebApi for Pathway. This function is useful to retrieve the current Pathway
#' specifications.
#'
#' @template BaseUrl
#' @return
#' A tibble of specification metadata for Pathway. Note: modifiedDate and createdDate are returned as
#' text/character.
#'
#' @examples
#' \dontrun{
#' getPathwayDefinitionsMetaData(baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getPathwayDefinitionsMetaData <- function(baseUrl) {
  .checkBaseUrl(baseUrl)
  metaData <- getDefinitionsMetadata(baseUrl = baseUrl, categories = c("pathway"))
  metaData <- .convertNulltoNA(metaData)
  return(metaData)
}


#' Check if Pathway id is valid.
#'
#' @details
#' Checks if a set of id for a Pathway is valid, i.e. checks if all the ids exists in the WebApi i.e.
#' valid.
#'
#' @template BaseUrl
#' @param pathwayIds   A list of integer id(s) of the Pathway to be tested for validity.
#' @return
#' A logical vector indicating which of the ids are valid.
#'
#' @examples
#' \dontrun{
#' isValidPathwayId(pathwayIds = c(13242, 3423, 34), baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
isValidPathwayId <- function(pathwayIds, baseUrl) {
  .checkBaseUrl(baseUrl)

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertIntegerish(pathwayIds, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  validIds <- getDefinitionsMetadata(baseUrl = baseUrl, categories = "pathway")
  return(pathwayIds %in% validIds$id)
}




#' Get Pathway id definition.
#'
#' @details
#' Obtain the Pathway definition from WebAPI for a given Pathway id
#'
#' @template BaseUrl
#' @param pathwayId   An integer id representing the id that uniquely identifies a Pathway definition
#'                    in a WebApi instance.
#' @return
#' An R object representing the Pathway definition
#'
#' @examples
#' \dontrun{
#' getPathwayDefinition(pathwayId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
getPathwayDefinition <- function(pathwayId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "pathway")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(pathwayId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  isValid <- isValidPathwayId(pathwayIds = pathwayId, baseUrl = baseUrl)

  if (isTRUE(isValid)) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", pathwayId)
    metaData <- httr::GET(url)
    metaData <- httr::content(metaData)
    if (!is.null(metaData$payload$message)) {
      stop(metaData$payload$message)
    }

    if (is.null(metaData$expression)) {
      if (!is.null(metaData$specification)) {
        metaData$expression <- metaData$specification
        metaData$specification <- NULL
      } else if (!is.null(metaData$design)) {
        metaData$expression <- metaData$design
        metaData$design <- NULL
      } else {
        if (argument$categoryUrlGetExpression != "") {
          urlExpression <- paste0(baseUrl,
                                  "/",
                                  argument$categoryUrl,
                                  "/",
                                  pathwayId,
                                  "/",
                                  argument$categoryUrlGetExpression)
          expression <- httr::GET(urlExpression)
          expression <- httr::content(expression)
          metaData$expression <- expression
        } else {
          metaData$expression <- metaData
          metaData$expression$name <- NULL
        }
      }
    }
    if (is.character(metaData$expression)) {
      if (jsonlite::validate(metaData$expression)) {
        metaData$expression <- RJSONIO::fromJSON(metaData$expression, nullValue = NA)
      }
    }
    return(metaData)
  } else {
    stop("PathwayId : pathwayId is not present in the WebApi.")
  }
}




#' Delete Pathway id definition.
#'
#' @details
#' Delete the Pathway definition from WebAPI for a given Pathway id
#'
#' @template BaseUrl
#' @param pathwayId   An integer id representing the id that uniquely identifies a Pathway definition
#'                    in a WebApi instance.
#' @return
#' An R object representing the Pathway definition
#'
#' @examples
#' \dontrun{
#' deletePathwayDefinition(pathwayId = 13242, baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
deletePathwayDefinition <- function(pathwayId, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "pathway")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(pathwayId, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidPathwayId(pathwayIds = pathwayId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", pathwayId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("PathwayId : pathwayId is not present in the WebApi.")
  }
}




#' Check if Pathway definition name exists.
#'
#' @details
#' Check if a string name already exists in the WebApi as a Pathway definition name.
#'
#' @template BaseUrl
#' @param pathwayName   A string name for the Pathway to be checked.
#' @return
#' If found, the function will return a tibble with details of the specification. If not found, FALSE
#' will be returned.
#'
#' @examples
#' \dontrun{
#' existsPathwayName(pathwayName = "this text string needs to be checked",
#'                   baseUrl = "http://server.org:80/WebAPI")
#' }
#' @export
# Check name
existsPathwayName <- function(pathwayName, baseUrl) {
  definitionsMetaData <- getPathwayDefinitionsMetaData(baseUrl = baseUrl)
  matched <- definitionsMetaData %>% dplyr::filter(name == .data$pathwayName)

  if (nrow(matched) > 0) {
    return(matched)
  } else {
    FALSE
  }
}

#' Get generation information for Pathway id.
#'
#' @details
#' Get generation (execution) information about Pathway for a given combination of sourceKey and
#' pathwayId.
#'
#' @template BaseUrl
#' @template SourceKey
#' @param pathwayId   An integer id representing the id that uniquely identifies a Pathway definition
#'                    in a WebApi instance.
#' @return
#' An R object representing the Pathway definition
#'
#' @examples
#' \dontrun{
#' getPathwayGenerationInformation(pathwayId = 13242,
#'                                 baseUrl = "http://server.org:80/WebAPI",
#'                                 sourceKey = "HCUP")
#' }
#' @export
getPathwayGenerationInformation <- function(pathwayId, sourceKey, baseUrl) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "pathway")

  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(pathwayId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  url <- paste0(baseUrl,
                "/",
                argument$categoryUrl,
                "/",
                pathwayId,
                "/",
                argument$categoryUrlGenerationInformation)
  response <- httr::GET(url)
  if (!response$status_code %in% c(100, 200)) {
    stop("No Pathway generation information found.")
  }
  response <- httr::content(response)

  responseAll <- list()
  for (i in (1:length(response))) {
    responseAll[[i]] <- response[[i]] %>% unlist(recursive = TRUE,
                                                 use.names = TRUE) %>% as.matrix() %>%
      t() %>% tidyr::as_tibble() %>% dplyr::mutate_if(.integerCharacters,
                                                      as.integer) %>% dplyr::mutate_if(.numericCharacters,
                                                                                       as.numeric) %>% dplyr::mutate_if(.logicalCharacters, as.logical) %>% dplyr::mutate(pathwayId = !!pathwayId) %>%
      dplyr::mutate(listId = !!i)
  }
  response <- dplyr::bind_rows(responseAll)

  cdmDataSources <- getCdmSources(baseUrl) %>% dplyr::select(.data$sourceId, .data$sourceKey)

  if ("executionInfo.id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "executionInfo.",
                                            replacement = "")
  }
  if ("id.sourceId" %in% colnames(response)) {
    names(response) <- stringr::str_replace(string = names(response),
                                            pattern = "id.",
                                            replacement = "")
  }
  if ("sourceId" %in% colnames(response)) {
    response <- response %>% dplyr::left_join(y = cdmDataSources, by = "sourceId")
  }
  return(response)
}





#' Invoke generation of Pathway id.
#'
#' @details
#' Invoke the generation of Pathway id in the WebApi.
#'
#' @template BaseUrl
#' @param pathwayId   An integer id representing the id that uniquely identifies a Pathway definition
#'                    in a WebApi instance.
#' @template SourceKey
#' @return
#' An R object representing the Pathway definition
#'
#' @examples
#' \dontrun{
#' invokePathwayDefinition(PathwayId = 13242,
#'                         baseUrl = "http://server.org:80/WebAPI",
#'                         sourceKey = "HCUP")
#' }
#' @export
invokePathwayDefinition <- function(pathwayId, baseUrl, sourceKey) {
  .checkBaseUrl(baseUrl)

  argument <- ROhdsiWebApi:::.getStandardCategories() %>% dplyr::filter(categoryStandard == "pathway")

  # get valid source keys from webapi
  validSourceKeys <- getCdmSources(baseUrl = baseUrl) %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull()
  errorMessage <- checkmate::makeAssertCollection()
  checkmate::assertInt(pathwayId, add = errorMessage)
  checkmate::assertScalar(sourceKey, add = errorMessage)
  checkmate::assertNames(sourceKey,
                         subset.of = validSourceKeys %>% dplyr::select(sourceKey) %>% dplyr::distinct() %>%
    dplyr::pull(), add = errorMessage)
  checkmate::reportAssertions(errorMessage)

  if (isTRUE(isValidPathwayId(pathwayIds = pathwayId, baseUrl = baseUrl))) {
    url <- paste0(baseUrl, "/", argument$categoryUrl, "/", pathwayId)
    response <- httr::DELETE(url)
    response <- httr::http_status(response)
  } else {
    stop("PathwayId : pathwayId is not present in the WebApi.")
  }
}
